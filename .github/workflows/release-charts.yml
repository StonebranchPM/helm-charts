name: Helm Charts CI + Release

on:
  push:
    branches:
      - '**'          # run on all branches
  pull_request:
    branches:
      - main          # validate on PRs into main

permissions:
  contents: write

jobs:
  validate-charts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug - list repo root (optional)
        run: |
          set -euo pipefail
          pwd
          ls -R

      - name: Install dependencies (zip, yamllint)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y zip yamllint

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Validate Helm charts
        run: |
          set -euo pipefail

          # Discover chart directories automatically
          CHARTS=()
          for dir in helm_ua_* helm_uac_*; do
            if [ -d "$dir" ] && [ -f "$dir/Chart.yaml" ]; then
              CHARTS+=("$dir")
            fi
          done

          echo "Discovered chart directories:"
          printf '  - %s\n' "${CHARTS[@]:-<none>}"

          if [ "${#CHARTS[@]}" -eq 0 ]; then
            echo "WARNING: No Helm chart directories found (helm_ua_*/helm_uac_* with Chart.yaml)."
          fi

          # Relaxed yamllint config
          YAMLLINT_CONF='{extends: default,
            rules: {
              line-length: {max: 200, level: warning},
              trailing-spaces: {level: warning},
              comments: {min-spaces-from-content: 1, level: warning},
              document-start: disable
            }}'

          for chart in "${CHARTS[@]}"; do
            echo "=== Validating $chart ==="

            if [ -f "$chart/values.yaml" ]; then
              echo "Running yamllint on $chart/values.yaml..."
              yamllint -d "$YAMLLINT_CONF" "$chart/values.yaml"
            else
              echo "WARNING: $chart/values.yaml not found"
            fi

            echo "Running helm lint on $chart..."
            helm lint "$chart"

            echo "Rendering templates for $chart..."
            BASENAME="$(basename "$chart")"
            RELEASE_NAME="$(printf '%s' "$_
