name: Helm Charts CI + Release

on:
  push:
    branches:
      - '**'          # run on all branches
  pull_request:
    branches:
      - main          # validate on PRs into main

permissions:
  contents: write

jobs:
  validate-charts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug - list repo root (optional)
        run: |
          set -euo pipefail
          pwd
          ls -R

      - name: Install dependencies (zip, yamllint)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y zip yamllint

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Validate Helm charts
        run: |
          set -euo pipefail

          # Discover chart directories automatically
          CHARTS=()
          for dir in helm_ua_* helm_uac_*; do
            if [ -d "$dir" ] && [ -f "$dir/Chart.yaml" ]; then
              CHARTS+=("$dir")
            fi
          done

          echo "Discovered chart directories:"
          printf '  - %s\n' "${CHARTS[@]:-<none>}"

          if [ "${#CHARTS[@]}" -eq 0 ]; then
            echo "WARNING: No Helm chart directories found (helm_ua_*/helm_uac_* with Chart.yaml)."
          fi

          # Relaxed yamllint config (single-line, no fancy quoting)
          YAMLLINT_CONF='{extends: default, rules: {line-length: {max: 200, level: warning}, trailing-spaces: {level: warning}, comments: {min-spaces-from-content: 1, level: warning}, document-start: disable}}'

          for chart in "${CHARTS[@]}"; do
            echo "=== Validating $chart ==="

            if [ -f "$chart/values.yaml" ]; then
              echo "Running yamllint on $chart/values.yaml..."
              yamllint -d "$YAMLLINT_CONF" "$chart/values.yaml"
            else
              echo "WARNING: $chart/values.yaml not found"
            fi

            echo "Running helm lint on $chart..."
            helm lint "$chart"

            echo "Rendering templates for $chart..."
            BASENAME="$(basename "$chart")"
            RELEASE_NAME="$(printf '%s' "$BASENAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')"
            helm template "$RELEASE_NAME" "$chart" > /dev/null
          done

  release-charts:
    needs: validate-charts
    runs-on: ubuntu-latest
    # Only run packaging + release when pushing to main
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (zip, yamllint)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y zip yamllint

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Prepare chart packages (ZIP + Helm TGZ)
        run: |
          set -euo pipefail

          WORKDIR="$(pwd)"
          TMP_DIR="/tmp/charts"
          mkdir -p "$TMP_DIR"

          echo "Packaging charts from: $WORKDIR"

          # Discover charts for packaging
          CHARTS=()
          for dir in helm_ua_* helm_uac_*; do
            if [ -d "$dir" ] && [ -f "$dir/Chart.yaml" ]; then
              CHARTS+=("$dir")
            fi
          done

          echo "Discovered chart directories for packaging:"
          printf '  - %s\n' "${CHARTS[@]:-<none>}"

          if [ "${#CHARTS[@]}" -eq 0 ]; then
            echo "ERROR: No Helm chart directories found."
            exit 1
          fi

          # UAC chart detection
          is_uac_chart() {
            case "$(basename "$1")" in
              helm_uac_*) return 0 ;;
              *)          return 1 ;;
            esac
          }

          for chart in "${CHARTS[@]}"; do
            echo "Processing $chart..."

            cp -r "$WORKDIR/$chart" "$TMP_DIR/$chart"

            if is_uac_chart "$chart"; then
              VALUES_FILE="$TMP_DIR/$chart/values.yaml"
              if [ -f "$VALUES_FILE" ]; then
                echo "  Removing private image references from $VALUES_FILE"
                sed -i '/^############################################ UC Deployment/a # REQUIRED: Provide your Universal Controller image repository and tag below' "$VALUES_FILE"
                sed -i '/^ucDeployment:/,/^[^ ]/ s/^\(\s*repository:\s*\).*/\1""/' "$VALUES_FILE"
                sed -i '/^ucDeployment:/,/^[^ ]/ s/^\(\s*tag:\s*\).*/\1""/' "$VALUES_FILE"
              fi
            fi

            BASENAME="$(basename "$chart")"

            # ZIP packaging
            (
              cd "$TMP_DIR"
              zip -9 -r "${BASENAME}.zip" "${BASENAME}" > /dev/null
            )
            echo "Created ${TMP_DIR}/${BASENAME}.zip"

            # Helm package (.tgz)
            echo "Creating Helm package for $chart..."
            helm package "$TMP_DIR/$chart" -d "$TMP_DIR" > /dev/null
          done

          echo "=== Packaged files ==="
          ls -lh "$TMP_DIR" || echo "No files in $TMP_DIR"

      - name: Ensure charts were packaged
        run: |
          set -euo pipefail
          if ! ls /tmp/charts/*.zip >/dev/null 2>&1 && ! ls /tmp/charts/*.tgz >/dev/null 2>&1; then
            echo "ERROR: No chart packages were created."
            exit 1
          fi

      - name: Create/Update GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: latest
          name: Latest Helm Charts
          body: |
            # Stonebranch Universal Automation Helm Charts

            This release contains the latest versions of Helm charts for deploying Stonebranch Universal Automation components on Kubernetes.

            ## Available Charts

            - helm_ua_aks.zip and corresponding ua-aks.tgz Helm package
            - helm_ua_ocp.zip and corresponding ua-ocp.tgz Helm package
            - helm_uac_aks.zip and corresponding uc-aks.tgz Helm package
            - helm_uac_ocp.zip and corresponding uc-ocp.tgz Helm package

            ## How to Install

            ### Option A – From ZIP (editable chart directory)

            1. Download the appropriate ZIP file from this release, for example:
               - helm_ua_v1.5-aks.zip
            2. Extract the archive:
               - unzip helm_ua_v1.5-aks.zip
               - cd helm_ua_v1.5-aks
            3. Review and customize values.yaml according to your environment.
            4. Install the chart:
               - helm install <release-name> . -n stonebranch --create-namespace

            ### Option B – From Helm package (.tgz)

            1. Download the appropriate .tgz file from this release, for example:
               - ua-aks-1.5.0.tgz
            2. Optional: inspect default values:
               - helm show values ua-aks-1.5.0.tgz
            3. Install the chart directly from the package:
               - helm install <release-name> ua-aks-1.5.0.tgz -n stonebranch --create-namespace

            ## UAC Image Configuration (Required)

            For Universal Controller + OMS (UAC) charts, you must provide your own Universal Controller image details in values.yaml before installation:

            ucDeployment:
              image:
                repository: "<your-controller-image-repository>"
                tag: "<your-controller-image-tag>"

          artifacts: "/tmp/charts/*.zip,/tmp/charts/*.tgz"
          allowUpdates: true
          removeArtifacts: true
          replacesArtifacts: true
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}
